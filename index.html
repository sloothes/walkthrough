<!DOCTYPE html>
<html lang="ja" class="no-js">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width">
<title></title>
<style>
body{
  margin: 0;
}
canvas{
  display: block;
}
.splash{
  color: #fff;
  text-align: center;
  box-sizing: border-box;
  padding: 30px 10px;
  left:0;
  right:0;
  top:0;
  bottom:0;
  position: absolute;
  z-index: 100;
  -webkit-transition: all .2s;
     -moz-transition: all .2s;
      -ms-transition: all .2s;
       -o-transition: all .2s;
          transition: all .2s;
  background: #59C8B2;
}
.splash--loaded{
  top:-100%;
  bottom:100%;
}
.splash__text{
  font-size: 20px;
  text-align: center;
}
.splash__instruction{
  margin: 20px auto 50px;
}
.splash__instruction img{
  display: block;
  margin: 0 auto;
}
.splash__spinner{
  display: block;
  padding-bottom: 80px;
  margin: 20px auto;
  background: url(img/spinner.gif) no-repeat 50% 100%;
}
.splash__playbutton{
  color: #fff;
  text-align: center;
  letter-spacing: .01em;
  cursor: pointer;
  width: 160px;
  padding: 12px 0;
  margin: 20px auto;
  border-radius: 3px;
  background: #536270;
  display: none;
}
</style>
</head>
<body>

<div class="splash">
  <div class="splash__text">walk and explore into 3D world!</div>
  <div class="splash__instruction"><img src="img/img_01.png" alt="" height="160" width="600"></div>
  <div class="splash__spinner">It takes some time to load</div>
  <div class="splash__playbutton">Play</div>
</div>

<script src="./lib/three.min.js"></script>
<script src="./lib/threefield.min.js"></script>

<!-- for only to use $.Deferred -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script>
var loadMesh = function ( url ) {

  var d = new $.Deferred(),
      loader = new THREE.JSONLoader();

    loader.load( url, function( geometry, materials ) {

    d.resolve( { geometry: geometry, materials: materials } );

  } );

  return d.promise();

};

var $splash  = $( '.splash' );
var $spinner = $( '.splash__spinner' );
var $button  = $( '.splash__playbutton' );

var width, height, clock, scene, camera, renderer;
var ambientLight, directionalLight, terrain, box;
var world, groundBody, playerRadius = 1, playerObjectHolder, playerController, animationController;

world = new THREEFIELD.World();

width = window.innerWidth;
height = window.innerHeight;
clock = new THREE.Clock();
scene = new THREE.Scene();
// scene.fog = new THREE.FogExp2( 0x000000, 0.02 );
camera = new THREE.PerspectiveCamera( 40, width / height, 1, 100 );
camera.position.set( 0, 5, 30 );
renderer = new THREE.WebGLRenderer();
renderer.setSize( width, height );
// renderer.setClearColor( 0xccccff );
document.body.appendChild( renderer.domElement );

ambientLight = new THREE.AmbientLight( 0xffffff );
scene.add( ambientLight );

directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
directionalLight.position.set( 0, 1, 0 );
scene.add( directionalLight );

playerObjectHolder = new THREE.Object3D();
playerObjectHolder.position.set( -55, 10, -1 );
scene.add( playerObjectHolder );

playerController = new THREEFIELD.CharacterController( playerObjectHolder, playerRadius, world );
playerController.movementSpeed = 10;

var keyInputControl = new THREEFIELD.KeyInputControl();

keyInputControl.addEventListener( 'movekeyhold', function () { playerController.isWalking = true; } );
keyInputControl.addEventListener( 'movekeyrelease',   function () { playerController.isWalking = false; } );
keyInputControl.addEventListener( 'jumpkeypress', function () { playerController.jump(); } );

playerController.addEventListener( 'startIdling',  function () { animationController.play( 'idle' ); } );
playerController.addEventListener( 'startWalking', function () { animationController.play( 'run' ); } );
playerController.addEventListener( 'startJumping', function () { animationController.play( 'jump' ); } );


var gyroscopeCameraControl = new THREEFIELD.GyroscopeCameraControl(
  camera,
  playerObjectHolder,
  {
    el: renderer.domElement,
    offset: new THREE.Vector3( 0, .5, 0 ), // eye height
    radius: 6,
    minRadius: 1.5,
    // maxRadius: 80,
    rigidObjects: []
  }
);



$.when(
  loadMesh( './terrain2/terrain1.js' ),
  loadMesh( './terrain2/terrain2.js' ),
  loadMesh( './terrain2/terrain3.js' ),
  loadMesh( './terrain2/BridgeChina.js' ),
  loadMesh( './terrain2/webgl-ie.js' ),
  loadMesh( './mobuko/mobuko.js' )
).then( function ( terrainData1, terrainData2, terrainData3, bridgeData, logoData, mobukoData ) {

  var d = new $.Deferred(),
      loadedData = {
        terrainData1 : terrainData1,
        terrainData2 : terrainData2,
        terrainData3 : terrainData3,
        bridgeData   : bridgeData,
        logoData     : logoData,
        mobukoData   : mobukoData
      }
  $spinner.slideUp();
  $button.slideDown();

  $button.on( 'click', function () {

    d.resolve( loadedData );

  } );

  return d;

} ).then( function ( loadedData ) {

  $splash.addClass( 'splash--loaded' );
  // terrain
  var terrainMesh1 = new THREE.Mesh(
    loadedData.terrainData1.geometry,
    // new THREE.MeshNormalMaterial()
    new THREE.MeshFaceMaterial( loadedData.terrainData1.materials )
  );
  terrainMesh1.scale.set( 8, 8, 8 );
  scene.add( terrainMesh1 );
  world.add( new THREEFIELD.Collider( terrainMesh1 ) );
  gyroscopeCameraControl.rigidObjects.push( terrainMesh1 );

  var terrainMesh2 = new THREE.Mesh(
    loadedData.terrainData2.geometry,
    // new THREE.MeshNormalMaterial()
    new THREE.MeshFaceMaterial( loadedData.terrainData2.materials )
  );
  terrainMesh2.scale.set( 8, 8, 8 );
  scene.add( terrainMesh2 );
  world.add( new THREEFIELD.Collider( terrainMesh2 ) );
  gyroscopeCameraControl.rigidObjects.push( terrainMesh2 );

  var terrainMesh3 = new THREE.Mesh(
    loadedData.terrainData3.geometry,
    // new THREE.MeshNormalMaterial()
    new THREE.MeshFaceMaterial( loadedData.terrainData3.materials )
  );
  terrainMesh3.scale.set( 8, 8, 8 );
  scene.add( terrainMesh3 );
  world.add( new THREEFIELD.Collider( terrainMesh3 ) );
  gyroscopeCameraControl.rigidObjects.push( terrainMesh3 );

  var bridgeMesh = new THREE.Mesh(
    loadedData.bridgeData.geometry,
    // new THREE.MeshNormalMaterial()
    new THREE.MeshFaceMaterial( loadedData.bridgeData.materials )
  );
  bridgeMesh.position.set( 60, -4.5, 24 );
  bridgeMesh.scale.set( 6, 6, 6 );
  scene.add( bridgeMesh );
  world.add( new THREEFIELD.Collider( bridgeMesh ) );
  gyroscopeCameraControl.rigidObjects.push( bridgeMesh );

  var logoMesh = new THREE.Mesh(
    loadedData.logoData.geometry,
    // new THREE.MeshNormalMaterial()
    new THREE.MeshFaceMaterial( loadedData.logoData.materials )
  );
  logoMesh.position.set( -65, 1, 65 );
  logoMesh.scale.set( 2, 2, 2 );
  logoMesh.rotation.x = Math.PI / 2;
  scene.add( logoMesh );




  // Mobuko-san
  var mobukoMesh;

  loadedData.mobukoData.materials.forEach(function ( material ) {
    material.skinning = true;
  } );

  mobukoMesh = new THREE.SkinnedMesh(
    loadedData.mobukoData.geometry,
    new THREE.MeshFaceMaterial( loadedData.mobukoData.materials )
  );
  mobukoMesh.scale.set( .5, .5, .5 );

  scene.add( mobukoMesh );
  animationController = new THREEFIELD.AnimationController( mobukoMesh );
  animationController.action.jump.anim.loop = false;
  animationController.action.land.anim.loop = false;
  animationController.action.slide.anim.loop = false;

  var duration = animationController.action.land.duration;
  animationController.play( 'idle' );


  // count=0;
  ;( function update () {
    // count++
    // if(count>1500){return}
    requestAnimationFrame( update );

    var delta = clock.getDelta();
    var cameraFrontAngle = gyroscopeCameraControl.getFrontAngle();
    var characterFrontAngle = keyInputControl.getFrontAngle();
    playerController.frontAngle = ( 360 - cameraFrontAngle ) + characterFrontAngle % 360;
    // since nested objects are cause IE11 slow, just copy position
    animationController.mesh.position.set(
      playerObjectHolder.position.x,
      playerObjectHolder.position.y - playerRadius,
      playerObjectHolder.position.z
    );
    animationController.mesh.rotation.y = THREE.Math.degToRad( ( 360 - cameraFrontAngle ) + characterFrontAngle % 360 ) + Math.PI;
    gyroscopeCameraControl.update();

    world.step( delta );
    renderer.render( scene, camera );
    THREE.AnimationHandler.update( delta );

    logoMesh.rotation.z += delta;

    if ( playerController.object.position.x < -80 ) {

      playerController.object.position.x = -80;

    }

    if ( playerController.object.position.x >  80 ) {

      playerController.object.position.x =  80;

    }

    if ( playerController.object.position.z < -80 ) {

      playerController.object.position.z = -80;

    }

    if ( playerController.object.position.z >  80 ) {

      playerController.object.position.z =  80;

    }

  } )();

} );

$( window ).on( 'resize', function onresize () {

  width = window.innerWidth,
  height = window.innerHeight;
  renderer.setSize( width, height );
  camera.aspect = width / height;
  camera.updateProjectionMatrix();

} );


</script>

</body>
</html>
